<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Interview Test</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
    --primary: rgb(0, 195, 255);       /* bright blue */
    --primary-dark: rgb(125, 95, 255); /* purple */
    --bg-light: rgb(12, 15, 36);       /* dark background */
    --panel-bg: rgb(22, 27, 60);       /* panel background */
    --border: rgb(55, 70, 120);        /* border */
    --text-dark: rgb(230, 240, 255);   /* light text */
    --text-muted: rgb(190, 200, 225);  /* muted text */
    --visited: rgb(0, 195, 255);       /* visited question */
    --not-visited: rgb(130, 140, 165); /* not visited */
    --answered: rgb(125, 95, 255);     /* answered question */
    --not-answered: rgb(239, 68, 68);  /* not answered */
}

/* ---------- Base ---------- */
* { box-sizing: border-box; margin:0; padding:0; }
body {
    font-family: 'Poppins', sans-serif;
    background: radial-gradient(circle at top left, rgb(12, 15, 36), rgb(45, 60, 115) 70%);
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
    color: var(--text-dark);
}

/* ---------- HEADER ---------- */
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 30px;
    background: var(--panel-bg);
    border-bottom: 2px solid var(--border);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.header .title {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-dark);
}

.header .timer {
    font-weight: 700;
    font-size: 1.4rem;
    color: #fff;
    padding: 8px 20px;
    border-radius: 8px;
    background: linear-gradient(135deg, var(--visited) 0%, var(--primary-dark) 100%);
    box-shadow: 0 4px 10px rgba(0, 195, 255, 0.3);
}

/* ---------- MAIN LAYOUT ---------- */
.main {
    display: flex;
    flex: 1;
    overflow: hidden;
}

/* ---------- LEFT SIDEBAR ---------- */
.left-sidebar {
    width: 300px;
    min-width: 300px;
    background: var(--panel-bg);
    border-right: 2px solid var(--border);
    display: flex;
    flex-direction: column;
    padding: 20px;
    overflow-y: auto;
}

.left-sidebar h3 {
    font-size: 1rem;
    color: var(--text-dark);
    margin-bottom: 15px;
    font-weight: 600;
}

.question-palette {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
    margin-bottom: 20px;
}

.question-palette button {
    padding: 12px 8px;
    font-size: 1rem;
    font-weight: 600;
    border-radius: 6px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.2s;
    min-height: 42px;
}

.question-palette button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

.question-palette .visited { 
    background: var(--visited); 
    color: #fff; 
}

.question-palette .not-visited { 
    background: var(--not-visited); 
    color: #666; 
}

.question-palette .answered { 
    background: var(--answered); 
    color: #fff; 
}

.question-palette .not-answered { 
    background: var(--not-answered); 
    color: #fff; 
}

.question-palette .current { 
    border: 3px solid rgb(239, 68, 68) !important;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
}

.legend {
    margin-top: auto;
    padding: 15px;
    background: rgb(25, 30, 60);
    border-radius: 8px;
    font-size: 0.8rem;
    color: var(--text-muted);
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.legend-box { 
    width: 18px; 
    height: 18px; 
    border-radius: 4px;
}

.visited-box { background: var(--visited); }
.not-visited-box { background: var(--not-visited); }
.answered-box { background: var(--answered); }
.not-answered-box { background: var(--not-answered); }

/* ---------- RIGHT CONTENT ---------- */
.right-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.question-area {
    flex: 1;
    padding: 30px;
    background: var(--panel-bg);
    overflow-y: auto;
}

.question-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
}

.q-number {
    background: linear-gradient(135deg, var(--visited) 0%, var(--primary-dark) 100%);
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 700;
    font-size: 1.1rem;
}

.question {
    font-size: 1.3rem;
    line-height: 1.8;
    color: var(--text-dark);
    font-weight: 500;
}

/* ---------- BOTTOM CONTROL PANEL ---------- */
.control-panel {
    background: var(--panel-bg);
    border-top: 2px solid var(--border);
    padding: 20px 30px;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
}

.audio-section {
    margin-bottom: 15px;
}

.audio-controls {
    display: flex;
    gap: 15px;
    align-items: center;
}

.record-btn {
    padding: 12px 30px;
    font-size: 1rem;
    font-weight: 600;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background: linear-gradient(135deg, var(--visited) 0%, var(--primary-dark) 100%);
    color: #fff;
    transition: 0.3s;
    box-shadow: 0 4px 12px rgba(0, 195, 255, 0.4);
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
}

.record-btn:hover { 
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 195, 255, 0.5);
}

.record-btn.recording {
    background: linear-gradient(135deg, var(--not-answered) 0%, rgb(220, 38, 38) 100%) !important;
    animation: pulse 1.5s ease-in-out infinite;
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.6) !important;
}

@keyframes pulse {
    0%, 100% { 
        opacity: 1;
        transform: scale(1);
    }
    50% { 
        opacity: 0.85;
        transform: scale(1.02);
    }
}

audio {
    flex: 1;
    height: 40px;
    border-radius: 8px;
}

.bottom-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.status-indicators {
    display: flex;
    gap: 15px;
    font-size: 0.85rem;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: rgb(25, 30, 60);
    border-radius: 6px;
    font-weight: 500;
    color: var(--text-muted);
}

.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

.next-btn {
    padding: 12px 35px;
    font-size: 1rem;
    font-weight: 600;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background: linear-gradient(135deg, var(--answered) 0%, rgb(95, 50, 255) 100%);
    color: #fff;
    transition: 0.3s;
    box-shadow: 0 4px 12px rgba(125, 95, 255, 0.4);
    display: flex;
    align-items: center;
    gap: 8px;
}

.next-btn:hover:not(:disabled) { 
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(125, 95, 255, 0.5);
}

.next-btn:disabled {
    background: var(--not-visited);
    cursor: not-allowed;
    box-shadow: none;
}

/* Responsive */
@media(max-width:900px){
    .main { flex-direction: column; }
    .left-sidebar { 
        width: 100%; 
        border-right: none; 
        border-bottom: 2px solid var(--border);
        max-height: 250px;
    }
    .question-palette { grid-template-columns: repeat(10, 1fr); }
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
    <div class="title">Practice Exam</div>
    <div class="timer" id="timer">02:00</div>
</div>

<!-- MAIN LAYOUT -->
<div class="main">
    <!-- LEFT SIDEBAR - QUESTION PALETTE -->
    <div class="left-sidebar">
        <h3>Question Palette</h3>
        <div class="question-palette" id="question-palette">
            <!-- Questions will be dynamically added here -->
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-box visited-box"></div>
                <span>Visited</span>
            </div>
            <div class="legend-item">
                <div class="legend-box not-visited-box"></div>
                <span>Not Visited</span>
            </div>
            <div class="legend-item">
                <div class="legend-box answered-box"></div>
                <span>Answered</span>
            </div>
            <div class="legend-item">
                <div class="legend-box not-answered-box"></div>
                <span>Not Answered</span>
            </div>
        </div>
    </div>

    <!-- RIGHT CONTENT -->
    <div class="right-content">
        <!-- QUESTION AREA -->
        <div class="question-area">
            <div class="question-header">
                <div class="q-number" id="q-number">Q.1</div>
            </div>
            <div class="question">
                <span id="question">{{ question }}</span>
            </div>
        </div>

        <!-- BOTTOM CONTROL PANEL -->
        <div class="control-panel">
            <div class="audio-section">
                <div class="audio-controls">
                    <button class="record-btn" id="record-btn">
                        <span id="record-icon">üéôÔ∏è</span>
                        <span id="record-text">Start Recording</span>
                    </button>
                    <audio id="audio-playback" controls></audio>
                </div>
            </div>
            
            <div class="bottom-actions">
                <div class="status-indicators">
                    <div class="status-item">
                        <div class="status-dot" style="background: var(--visited);"></div>
                        <span id="visited-count">1 Visited</span>
                    </div>
                    <div class="status-item">
                        <div class="status-dot" style="background: var(--answered);"></div>
                        <span id="answered-count">0 Answered</span>
                    </div>
                </div>
                <button class="next-btn" id="next-btn" disabled>
                    Next Question
                    <span>‚û°Ô∏è</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let totalQuestions = {{ total_questions }};
let currentQuestion = 1;
let audioBlob = null;
let mediaRecorder = null;
let audioStream = null;
let chunks = [];
const recordBtn = document.getElementById("record-btn");
const recordIcon = document.getElementById("record-icon");
const recordText = document.getElementById("record-text");
const nextBtn = document.getElementById("next-btn");
const audioPlayer = document.getElementById("audio-playback");
const timerEl = document.getElementById("timer");
let timeLeft = 120;
let timerInterval;
let questionStates = Array(totalQuestions).fill('not-visited');
questionStates[0] = 'visited';
let isRecording = false;

// ---------- TIMER ----------
function startTimer() {
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        const minutes = String(Math.floor(timeLeft / 60)).padStart(2, '0');
        const seconds = String(timeLeft % 60).padStart(2, '0');
        timerEl.innerText = `${minutes}:${seconds}`;
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            timerEl.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
        }
        timeLeft--;
    }, 1000);
}
startTimer();

// ---------- RECORD AUDIO ----------
// Function to start recording
async function startRecording() {
    try {
        if (!audioStream) {
            audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        }
        chunks = [];
        mediaRecorder = new MediaRecorder(audioStream);
        
        mediaRecorder.ondataavailable = e => {
            if (e.data.size > 0) chunks.push(e.data);
        };
        
        mediaRecorder.onstop = () => {
            audioBlob = new Blob(chunks, { type: 'audio/webm' });
            audioPlayer.src = URL.createObjectURL(audioBlob);
            nextBtn.disabled = false;
            questionStates[currentQuestion - 1] = 'answered';
            updatePalette();
            updateStatusCounts();
        };

        mediaRecorder.start();
        isRecording = true;
        recordBtn.classList.add('recording');
        recordIcon.innerText = '‚èπÔ∏è';
        recordText.innerText = 'Stop Recording';

    } catch (err) {
        console.error('Error accessing microphone:', err);
        alert('Please allow microphone access.');
    }
}

// Function to stop recording
function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
    }
    isRecording = false;
    recordBtn.classList.remove('recording');
    recordIcon.innerText = 'üéôÔ∏è';
    recordText.innerText = 'Start Recording';
}

// Toggle recording on button click
recordBtn.onclick = () => {
    if (!isRecording) {
        startRecording();
    } else {
        stopRecording();
    }
};

// ---------- QUESTION PALETTE ----------
const paletteEl = document.getElementById("question-palette");

// Dynamically create question buttons based on backend total_questions
for (let i = 1; i <= totalQuestions; i++) {
    const btn = document.createElement("button");
    btn.innerText = i;
    btn.className = i === 1 ? 'visited current' : 'not-visited';
    btn.onclick = () => jumpToQuestion(i);
    paletteEl.appendChild(btn);
}

function updatePalette() {
    const btns = paletteEl.querySelectorAll('button');
    btns.forEach((btn, idx) => {
        btn.className = questionStates[idx];
        if (idx + 1 === currentQuestion) {
            btn.classList.add('current');
        }
    });
}

function updateStatusCounts() {
    const visitedCount = questionStates.filter(s => s !== 'not-visited').length;
    const answeredCount = questionStates.filter(s => s === 'answered').length;
    document.getElementById('visited-count').innerText = `${visitedCount} Visited`;
    document.getElementById('answered-count').innerText = `${answeredCount} Answered`;
}

function jumpToQuestion(qNum) {
    // Mark as visited when jumping to a question
    if (questionStates[qNum - 1] === 'not-visited') {
        questionStates[qNum - 1] = 'visited';
    }
    
    currentQuestion = qNum;
    updatePalette();
    updateStatusCounts();
    document.getElementById("q-number").innerText = `Q.${qNum}`;
    
    // Reset audio for new question
    audioBlob = null;
    audioPlayer.src = '';
    
    // Stop recording if it's ongoing
    if (isRecording && mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        isRecording = false;
        recordBtn.classList.remove('recording');
        recordIcon.innerText = 'üéôÔ∏è';
        recordText.innerText = 'Start Recording';
    }
    
    // Enable next button only if this question was already answered
    nextBtn.disabled = questionStates[qNum - 1] !== 'answered';
    
    // Reset timer
    timeLeft = 120;
    startTimer();
}

// ---------- NEXT QUESTION ----------
nextBtn.onclick = async () => {
    nextBtn.disabled = true;
    
    // Send data to backend
    const fd = new FormData();
    if (audioBlob) fd.append("audio_data", audioBlob, "answer.wav");
    
    try {
        const res = await fetch("/next_question", { method: 'POST', body: fd });
        const data = await res.json();
        
        if (data.done) { 
            window.location.href = '/result'; 
            return; 
        }
        
        // Update question from backend
        document.getElementById("question").innerText = data.question;
        document.getElementById("q-number").innerText = 'Q.' + data.q_number;
        
        currentQuestion = data.q_number;
        if (questionStates[currentQuestion - 1] === 'not-visited') {
            questionStates[currentQuestion - 1] = 'visited';
        }
        
        updatePalette();
        updateStatusCounts();
        
        // Reset audio
        audioBlob = null;
        audioPlayer.src = '';
        
        // Reset recording button if it was recording
        if (isRecording && mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            isRecording = false;
            recordBtn.classList.remove('recording');
            recordIcon.innerText = 'üéôÔ∏è';
            recordText.innerText = 'Start Recording';
        }
        
        // Reset timer
        timeLeft = 120;
        startTimer();
    } catch (error) {
        console.error('Error fetching next question:', error);
        nextBtn.disabled = false;
    }
};

// Initialize status counts
updateStatusCounts();
</script>
</body>
</html>